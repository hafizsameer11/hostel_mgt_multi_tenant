// =================== PRISMA CONFIG ===================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =================== ENUMS ===================

enum Role {
  admin
  owner
  manager
  staff
  user
}

enum HostelStatus {
  active
  inactive
  under_maintenance
}

enum FloorStatus {
  active
  inactive
  under_maintenance
}

enum RoomType {
  single
  double
  triple
  quad
  dormitory
  suite
}

enum RoomStatus {
  vacant
  occupied
  under_maintenance
  reserved
}

enum Furnishing {
  furnished
  semi_furnished
  unfurnished
}

enum MaintenanceStatus {
  scheduled
  in_progress
  completed
}

enum BedType {
  single
  bunk_upper
  bunk_lower
  double
  queen
  king
}

enum BedStatus {
  available
  occupied
  reserved
  under_maintenance
}

enum BedCondition {
  good
  fair
  needs_repair
}

enum AllocationStatus {
  active
  checked_out
  transferred
  cancelled
}

enum PaymentStatus {
  pending
  paid
  partial
  overdue
}

enum PaymentMethod {
  cash
  card
  bank_transfer
  upi
  cheque
  online
  stripe
}

enum PaymentType {
  rent
  deposit
  maintenance
  electricity
  water
  other
}

enum TenantStatus {
  active
  inactive
  blacklisted
}

enum Gender {
  male
  female
  other
}

enum EmployeeStatus {
  active
  inactive
  on_leave
  terminated
}

enum EmployeeRole {
  staff
  manager
}

enum TransactionStatus {
  pending
  processing
  completed
  failed
  cancelled
  refunded
}

enum BookingType {
  online
  walkin
  admin
}

enum BookingStatus {
  pending
  confirmed
  checked_in
  checked_out
  cancelled
  expired
}

enum AlertType {
  bill
  rent
  payable
  receivable
  maintenance
}

enum AlertStatus {
  pending
  in_progress
  resolved
  dismissed
}

enum MaintenanceType {
  room_cleaning
  repairs
  purchase_demand
}

enum AlertPriority {
  low
  medium
  high
  urgent
}

enum VendorStatus {
  active
  inactive
  blacklisted
}

enum PaymentTerms {
  prepaid
  cod
  net15
  net30
  net45
  net60
}

enum CampaignChannel {
  email
  whatsapp
}

enum CampaignStatus {
  queued
  sent
  delivered
  read
  failed
  replied
}

// =================== MODELS ===================

model User {
  id        Int      @id @default(autoincrement())
  name      String?  @db.VarChar(255)
  email     String?  @unique @db.VarChar(255)
  phone     String?  @db.VarChar(50)
  password  String?  @db.VarChar(255)
  status    String   @default("active") @db.VarChar(50)
  role      Role     @default(user)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  managedHostels    Hostel[]           @relation("HostelManager")
  ownedHostels      Hostel[]           @relation("HostelOwner")
  tenantProfile     Tenant?            @relation("TenantUser")
  allocatedBy       Allocation[]       @relation("AllocationCreator")
  currentBeds       Bed[]              @relation("CurrentTenant")
  reservedBeds      Bed[]              @relation("BedReservation")
  paymentsCollected Payment[]          @relation("PaymentCollector")
  employeeProfile   Employee?          @relation("EmployeeUser")
  createdBookings   Booking[]          @relation("BookingCreator")
  assignedAlerts    Alert[]            @relation("AlertAssignedTo")
  createdAlerts     Alert[]            @relation("AlertCreator")
  resolvedAlerts    Alert[]            @relation("AlertResolver")
  emailCampaigns    EmailCampaign[]
  whatsappCampaigns WhatsAppCampaign[]
  ActivityLog       ActivityLog[]
  ScoreCard         ScoreCard[]

  @@index([email])
  @@index([role])
}

// =================== MAIN MODELS ===================

model Hostel {
  id             Int          @id @default(autoincrement())
  name           String?      @unique @db.VarChar(255)
  address        Json?
  description    String?      @db.Text
  totalFloors    Int?         @default(0)
  totalRooms     Int?         @default(0)
  totalBeds      Int?         @default(0)
  occupiedBeds   Int?         @default(0)
  amenities      Json?
  contactInfo    Json?
  operatingHours Json?
  status         HostelStatus @default(active)
  managedBy      Int?
  ownerId        Int?
  images         Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  manager      User?         @relation("HostelManager", fields: [managedBy], references: [id], onDelete: SetNull)
  owner        User?         @relation("HostelOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  floors       Floor[]
  rooms        Room[]
  allocations  Allocation[]
  payments     Payment[]
  transactions Transaction[]
  bookings     Booking[]
  alerts       Alert[]
  vendors      Vendor[]
  expenses     Expense[]
  fpas         FPA[]
  beds         Bed[]

  @@index([name])
  @@index([status])
  @@index([managedBy])
  @@index([ownerId])
}

model Tenant {
  id               Int          @id @default(autoincrement())
  userId           Int?         @unique
  name             String
  email            String?      @unique
  phone            String
  alternatePhone   String?
  gender           Gender?
  dateOfBirth      DateTime?
  cnicNumber       String?      @unique
  address          Json?
  permanentAddress Json?
  emergencyContact Json?
  occupation       String?
  companyName      String?
  designation      String?
  monthlyIncome    Float?
  leaseStartDate   DateTime?
  leaseEndDate     DateTime?
  monthlyRent      Float?
  documents        Json?
  profilePhoto     String?
  status           TenantStatus @default(active)
  totalPaid        Float        @default(0)
  totalDue         Float        @default(0)
  securityDeposit  Float        @default(0)
  notes            String?
  rating           Int?         @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  user         User?         @relation("TenantUser", fields: [userId], references: [id], onDelete: SetNull)
  allocations  Allocation[]  @relation("TenantAllocations")
  payments     Payment[]
  transactions Transaction[]
  bookings     Booking[]
  alerts       Alert[]

  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([name])
}

model Employee {
  id               Int            @id @default(autoincrement())
  userId           Int            @unique
  employeeCode     String?        @unique
  role             EmployeeRole   @default(staff)
  department       String?
  designation      String?
  salary           Float
  salaryType       String?        @default("monthly")
  joinDate         DateTime
  terminationDate  DateTime?
  status           EmployeeStatus @default(active)
  workingHours     Json?
  hostelAssigned   Int?
  bankDetails      Json?
  address          Json?
  documents        Json?
  profilePhoto     String?
  emergencyContact Json?
  qualifications   Json?
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  user User @relation("EmployeeUser", fields: [userId], references: [id], onDelete: Cascade)
}

model Vendor {
  id             Int           @id @default(autoincrement())
  hostelId       Int?
  name           String
  companyName    String?
  email          String?       @unique
  phone          String?
  alternatePhone String?
  category       String?
  services       Json?
  address        Json?
  paymentTerms   PaymentTerms? @default(net30)
  totalPayable   Float?        @default(0)
  totalPaid      Float?        @default(0)
  balance        Float?        @default(0)
  status         VendorStatus? @default(active)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  hostel Hostel? @relation(fields: [hostelId], references: [id], onDelete: SetNull)
}

// =================== EXPENSE MANAGEMENT ===================

model Expense {
  id        Int      @id @default(autoincrement())
  title     String
  category  String
  amount    Float
  type      String
  date      DateTime @default(now())
  hostelId  Int?
  hostel    Hostel?  @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================== FP&A SUMMARY ===================

model FPA {
  id            Int      @id @default(autoincrement())
  month         String
  year          Int
  totalIncome   Float    @default(0)
  totalExpense  Float    @default(0)
  profit        Float    @default(0)
  breakeven     Float    @default(0)
  cashflowRatio Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  hostelId Int?
  hostel   Hostel? @relation(fields: [hostelId], references: [id], onDelete: Cascade)

  @@unique([month, year, hostelId], name: "unique_fpa_month_year_hostel")
}

// =================== CAMPAIGNS ===================

model EmailCampaign {
  id           Int      @id @default(autoincrement())
  title        String
  subject      String
  message      String
  campaignType String?
  sendDate     DateTime @default(now())
  targetType   String
  recipients   Json?
  status       String?  @default("scheduled")
  createdBy    Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  creator User?         @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  logs    CampaignLog[]
}

model WhatsAppCampaign {
  id           Int      @id @default(autoincrement())
  title        String
  message      String
  campaignType String?
  sendDate     DateTime @default(now())
  targetType   String
  recipients   Json?
  status       String?  @default("scheduled")
  createdBy    Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  creator User?         @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  logs    CampaignLog[]
}

model CampaignLog {
  id                 Int             @id @default(autoincrement())
  channel            CampaignChannel
  status             CampaignStatus  @default(queued)
  emailCampaignId    Int?
  whatsappCampaignId Int?
  recipientType      String
  recipientId        Int?
  recipientEmail     String?
  recipientPhone     String?
  providerMessageId  String?         @unique
  deliveredAt        DateTime?
  readAt             DateTime?
  repliedAt          DateTime?
  replyText          String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  emailCampaign    EmailCampaign?    @relation(fields: [emailCampaignId], references: [id], onDelete: Cascade)
  whatsappCampaign WhatsAppCampaign? @relation(fields: [whatsappCampaignId], references: [id], onDelete: Cascade)
}

// =================== SETTINGS ===================

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================== CORE STRUCTURES ===================

model Floor {
  id           Int          @id @default(autoincrement())
  hostelId     Int
  floorNumber  Int
  floorName    String?      @db.VarChar(255)
  description  String?      @db.Text
  totalRooms   Int          @default(0)
  totalBeds    Int          @default(0)
  occupiedBeds Int          @default(0)
  amenities    Json?
  floorPlan    Json?
  status       FloorStatus  @default(active)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  hostel Hostel @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  rooms  Room[]
  beds   Bed[]
  allocations Allocation[]

  @@unique([hostelId, floorNumber], name: "hostelId_floorNumber")
  @@index([status])
  @@index([hostelId])
}

model Room {
  id                   Int        @id @default(autoincrement())
  hostelId             Int
  floorId              Int
  roomNumber           String     @db.VarChar(50)
  roomType             RoomType   @default(single)
  totalBeds            Int
  occupiedBeds         Int        @default(0)
  pricePerBed          Float
  status               RoomStatus @default(vacant)
  amenities            Json?
  dimensions           Json?
  hasAttachedBathroom  Boolean    @default(false)
  hasBalcony           Boolean    @default(false)
  furnishing           Furnishing @default(furnished)
  images               Json?
  maintenanceSchedule  Json?
  notes                String?    @db.Text
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  hostel Hostel @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  floor  Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  beds   Bed[]
  Booking Booking[]
  allocations Allocation[]

  @@unique([hostelId, roomNumber], name: "hostelId_roomNumber")
  @@index([status])
  @@index([hostelId])
  @@index([floorId])
}

model Bed {
  id                Int       @id @default(autoincrement())
  hostelId          Int
  floorId           Int
  roomId            Int
  bedNumber         String    @db.VarChar(50)
  bedType           BedType   @default(single)
  position          Json?
  status            BedStatus @default(available)
  currentUserId     Int?
  reservedById      Int?
  reservationExpiry DateTime?
  condition         BedCondition @default(good)
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  hostel       Hostel @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  floor        Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  room         Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  currentUser  User?  @relation("CurrentTenant", fields: [currentUserId], references: [id], onDelete: SetNull)
  reservedUser User?  @relation("BedReservation", fields: [reservedById], references: [id], onDelete: SetNull)
  allocations  Allocation[]

  @@unique([roomId, bedNumber], name: "roomId_bedNumber")
  @@index([status])
  @@index([hostelId])
  @@index([floorId])
  @@index([roomId])
}

model Allocation {
  id                  Int               @id @default(autoincrement())
  hostelId            Int
  floorId             Int
  roomId              Int
  bedId               Int
  tenantId            Int
  allocatedById       Int?
  allocationDate      DateTime          @default(now())
  checkInDate         DateTime
  checkOutDate        DateTime?
  expectedCheckOutDate DateTime?
  rentAmount          Float
  depositAmount       Float             @default(0)
  status              AllocationStatus  @default(active)
  paymentStatus       PaymentStatus     @default(pending)
  transferHistory     Json?
  notes               String?           @db.Text
  documents           Json?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  hostel      Hostel @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  floor       Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  room        Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  bed         Bed    @relation(fields: [bedId], references: [id], onDelete: Cascade)
  tenant      Tenant @relation("TenantAllocations", fields: [tenantId], references: [id], onDelete: Cascade)
  allocatedBy User?  @relation("AllocationCreator", fields: [allocatedById], references: [id], onDelete: SetNull)

  @@index([tenantId, status])
  @@index([bedId, status])
  @@index([roomId, status])
  @@index([hostelId, status])
  @@index([allocationDate])
  @@index([hostelId])
  @@index([floorId])
  @@index([roomId])
  @@index([bedId])
  @@index([tenantId])
  @@index([allocatedById])
}

model Payment {
  id          Int      @id @default(autoincrement())
  tenantId    Int?
  hostelId    Int?
  collectedBy Int?
  amount      Float
  status      String   @default("paid")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant?       @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  hostel      Hostel?       @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  collector   User?         @relation("PaymentCollector", fields: [collectedBy], references: [id], onDelete: SetNull)
  Transaction Transaction[]
}

model Transaction {
  id        Int      @id @default(autoincrement())
  paymentId Int?
  tenantId  Int?
  hostelId  Int?
  amount    Float
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  tenant  Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  hostel  Hostel?  @relation(fields: [hostelId], references: [id], onDelete: SetNull)
}

model Booking {
  id        Int       @id @default(autoincrement())
  tenantId  Int?
  hostelId  Int?
  roomId    Int?
  createdBy Int?
  checkIn   DateTime?
  checkOut  DateTime?
  status    String    @default("pending")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant  Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  hostel  Hostel? @relation(fields: [hostelId], references: [id], onDelete: SetNull)
  room    Room?   @relation(fields: [roomId], references: [id], onDelete: SetNull)
  creator User?   @relation("BookingCreator", fields: [createdBy], references: [id], onDelete: SetNull)
}

model Alert {
  id           Int      @id @default(autoincrement())
  hostelId     Int?
  tenantId     Int?
  assignedToId Int?
  createdById  Int?
  resolvedById Int?
  title        String
  description  String?
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  hostel     Hostel? @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  tenant     Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  assignedTo User?   @relation("AlertAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  creator    User?   @relation("AlertCreator", fields: [createdById], references: [id], onDelete: SetNull)
  resolver   User?   @relation("AlertResolver", fields: [resolvedById], references: [id], onDelete: SetNull)
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  action      String // create | update | delete | profile | settings | score
  module      String // manager | settings | profile | scorecard | ...
  description String?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([module])
  @@index([userId, createdAt])
}

model ScoreCard {
  id         Int      @id @default(autoincrement())
  entityType String // "tenant" | "employee"
  entityId   Int
  score      Float    @default(0)
  criteria   String? // e.g. "rent_punctuality" | "attendance"
  remarks    String?
  recordedBy Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  recorder User? @relation(fields: [recordedBy], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([createdAt])
}
